<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista de formulario para el wizard de normalizaci√≥n de etapas -->
    <record id="view_unificar_etapas_wizard_form" model="ir.ui.view">
        <field name="name">leulit_tarea.unificar_etapas_wizard.form</field>
        <field name="model">leulit_tarea.unificar_etapas_wizard</field>
        <field name="arch" type="xml">
            <form string="Normalizar Etapas de Proyectos y Tareas">
                <header>
                    <button name="action_analizar_etapas" string="Siguiente: Mapear Etapas" 
                            type="object" class="btn-primary"
                            invisible="estado != 'paso1'"/>
                    <button name="action_simular_cambios" string="Simular Cambios" 
                            type="object" class="btn-info"
                            invisible="estado != 'paso2'"/>
                    <button name="action_volver_paso1" string="‚Üê Volver a Paso 1" 
                            type="object" class="btn-secondary"
                            invisible="estado == 'paso1'"/>
                    <button name="action_unificar_etapas" string="üöÄ EJECUTAR NORMALIZACI√ìN" 
                            type="object" class="btn-danger"
                            confirm="¬øEst√°s seguro? Esta acci√≥n modificar√° los proyectos y tareas seleccionados."
                            invisible="estado != 'paso3' or modo_ejecucion == 'simulacion'"/>
                    <field name="estado" widget="statusbar" statusbar_visible="paso1,paso2,paso3"/>
                </header>
                <sheet>
                    <!-- PASO 1: SELECCI√ìN DE PROYECTOS -->
                    <div invisible="estado != 'paso1'">
                        <div class="oe_title">
                            <h1>
                                <span>Paso 1: Selecci√≥n de Proyectos</span>
                            </h1>
                        </div>
                        
                        <group>
                            <group>
                                <field name="aplicar_a_proyectos"/>
                            </group>
                            <group>
                            </group>
                        </group>
                        
                        <group invisible="aplicar_a_proyectos">
                            <field name="proyecto_ids" widget="many2many_checkboxes"
                                   context="{'tree_view_ref': 'project.view_project'}"/>
                        </group>
                        
                        <div class="oe_clear"/>
                        
                        <separator string="Informaci√≥n del Proceso"/>
                        <div class="alert alert-info" role="alert">
                            <h4><i class="fa fa-info-circle"/> ¬øQu√© hace esta herramienta?</h4>
                            <p>
                                <strong>Esta herramienta normaliza las etapas</strong> en los proyectos y tareas seleccionados, 
                                permiti√©ndote mapear cada etapa existente a una etapa destino estandarizada.
                            </p>
                            <ul>
                                <li><strong>Etapas Destino para Tareas:</strong> Pendiente, En proceso, Realizada, Pospuesta, N/A</li>
                                <li><strong>Proceso:</strong> En el siguiente paso ver√°s todas las etapas existentes y podr√°s mapear cada una a su etapa destino correspondiente</li>
                                <li><strong>Historial:</strong> Se mantiene el historial de cambios en las tareas</li>
                            </ul>
                        </div>
                        
                        <div class="alert alert-warning" role="alert">
                            <p>
                                <i class="fa fa-warning"/> <strong>Advertencia:</strong> Esta acci√≥n modificar√° las etapas de los proyectos y tareas. 
                                Se recomienda hacer una copia de seguridad antes de ejecutarla.
                            </p>
                        </div>
                    </div>
                    
                    <!-- PASO 2: MAPEO DE ETAPAS -->
                    <div invisible="estado != 'paso2'">
                        <div class="oe_title">
                            <h1>
                                <span>Paso 2: Mapeo de Etapas</span>
                            </h1>
                        </div>
                        
                        <group>
                            <group>
                                <field name="total_proyectos" readonly="1"/>
                            </group>
                            <group>
                                <field name="total_etapas_origen" readonly="1"/>
                            </group>
                        </group>
                        
                        <separator string="Mapeo: Etapas Existentes ‚Üí Etapas Destino"/>
                        <div class="alert alert-info" role="alert">
                            <p>
                                <i class="fa fa-info-circle"/> Para cada etapa existente, selecciona la etapa destino a la que debe mapearse.
                                Las etapas que coincidan exactamente con las etapas destino se han pre-seleccionado autom√°ticamente.
                            </p>
                        </div>
                        
                        <field name="mapeo_linea_ids" nolabel="1">
                            <tree editable="bottom" create="false" delete="false">
                                <field name="etapa_origen_nombre" readonly="1" string="Etapa Actual"/>
                                <field name="etapa_destino_id" string="‚Üí Etapa Destino" 
                                       domain="[('name', 'in', ['Pendiente', 'En proceso', 'Realizada', 'Pospuesta', 'N/A'])]"
                                       options="{'no_create': True, 'no_create_edit': True}"/>
                                <field name="proyectos_afectados" readonly="1" string="Proyectos"/>
                                <field name="tareas_afectadas" readonly="1" string="Tareas"/>
                                <field name="etapa_origen_id" invisible="1"/>
                            </tree>
                        </field>
                        
                        <div class="oe_clear"/>
                        
                        <separator string="Acciones que se realizar√°n"/>
                        <div class="alert alert-success" role="alert">
                            <h4><i class="fa fa-check-circle"/> El sistema ejecutar√° las siguientes acciones:</h4>
                            <ol>
                                <li><strong>Proyectos sin etapas:</strong> Se asignar√°n todas las etapas destino</li>
                                <li><strong>Etapas que coinciden:</strong> Se mantienen sin cambios</li>
                                <li><strong>Etapas mapeadas:</strong> Se sustituyen por la etapa destino (manteniendo historial en tareas)</li>
                                <li><strong>Etapas destino faltantes:</strong> Se a√±adir√°n al proyecto</li>
                            </ol>
                        </div>
                    </div>
                    
                    <!-- PASO 3: SIMULACI√ìN DE CAMBIOS -->
                    <div invisible="estado != 'paso3'">
                        <div class="oe_title">
                            <h1>
                                <span>Paso 3: Simulaci√≥n y Ejecuci√≥n</span>
                            </h1>
                        </div>
                        
                        <group>
                            <group>
                                <field name="modo_ejecucion" widget="radio"/>
                            </group>
                            <group>
                                <field name="crear_snapshot" 
                                       invisible="modo_ejecucion == 'simulacion'"/>
                                <field name="limpiar_etapas_obsoletas"
                                       invisible="modo_ejecucion == 'simulacion'"/>
                            </group>
                        </group>
                        
                        <separator string="Resultado de la Simulaci√≥n"/>
                        <div class="alert alert-info" role="alert">
                            <h4><i class="fa fa-info-circle"/> Vista Previa de Cambios</h4>
                            <p>A continuaci√≥n se muestran todos los cambios que se aplicar√≠an:</p>
                        </div>
                        
                        <group>
                            <field name="simulacion_stats" readonly="1" widget="text"/>
                        </group>
                        
                        <separator string="Detalle de Cambios"/>
                        <field name="simulacion_resultado" readonly="1" widget="text" 
                               style="font-family: monospace; white-space: pre-wrap; background-color: #f8f9fa; padding: 10px; border: 1px solid #dee2e6;"/>
                        
                        <div class="oe_clear"/>
                        
                        <div class="alert alert-warning" role="alert" invisible="modo_ejecucion == 'simulacion'">
                            <h4><i class="fa fa-warning"/> MODO EJECUCI√ìN REAL ACTIVADO</h4>
                            <p>
                                <strong>Al hacer clic en "EJECUTAR NORMALIZACI√ìN":</strong>
                            </p>
                            <ul>
                                <li>Se aplicar√°n TODOS los cambios mostrados arriba</li>
                                <li>Se modificar√°n los proyectos y tareas seg√∫n el mapeo definido</li>
                                <li invisible="not crear_snapshot">
                                    Se crear√° un snapshot autom√°tico que te permitir√° revertir los cambios
                                </li>
                                <li invisible="not limpiar_etapas_obsoletas">
                                    <strong style="color: #d9534f;">Se eliminar√°n las etapas obsoletas que no est√©n en uso</strong>
                                </li>
                            </ul>
                        </div>
                        
                        <div class="alert alert-danger" role="alert" invisible="modo_ejecucion == 'simulacion' or not limpiar_etapas_obsoletas">
                            <h4><i class="fa fa-exclamation-triangle"/> LIMPIEZA DE ETAPAS OBSOLETAS ACTIVADA</h4>
                            <p>
                                <strong>IMPORTANTE:</strong> Despu√©s de la normalizaci√≥n, se eliminar√°n autom√°ticamente las etapas antiguas 
                                que NO cumplan alguna de estas condiciones:
                            </p>
                            <ul>
                                <li>‚úì Ser una etapa destino normalizada</li>
                                <li>‚úì Estar asignada a alg√∫n proyecto como etapa disponible</li>
                                <li>‚úì Estar siendo usada por alguna tarea</li>
                            </ul>
                            <p><strong>Solo se eliminar√°n etapas completamente sin uso.</strong></p>
                        </div>
                        
                        <div class="alert alert-success" role="alert" invisible="modo_ejecucion == 'real'">
                            <h4><i class="fa fa-check-circle"/> MODO SIMULACI√ìN</h4>
                            <p>
                                Est√°s en modo simulaci√≥n. Los cambios NO se aplicar√°n.<br/>
                                Cambia a "Ejecuci√≥n Real" cuando est√©s listo para aplicar los cambios.
                            </p>
                        </div>
                    </div>
                </sheet>
                <footer>
                    <button string="Cancelar" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Vista Tree para Snapshots -->
    <record id="view_unificar_etapas_snapshot_tree" model="ir.ui.view">
        <field name="name">leulit_tarea.unificar_etapas_snapshot.tree</field>
        <field name="model">leulit_tarea.unificar_etapas_snapshot</field>
        <field name="arch" type="xml">
            <tree decoration-muted="not activo">
                <field name="name"/>
                <field name="fecha_snapshot"/>
                <field name="user_id"/>
                <field name="total_proyectos"/>
                <field name="total_tareas"/>
                <field name="activo"/>
            </tree>
        </field>
    </record>

    <!-- Vista Form para Snapshots -->
    <record id="view_unificar_etapas_snapshot_form" model="ir.ui.view">
        <field name="name">leulit_tarea.unificar_etapas_snapshot.form</field>
        <field name="model">leulit_tarea.unificar_etapas_snapshot</field>
        <field name="arch" type="xml">
            <form string="Snapshot de Rollback">
                <header>
                    <button name="action_rollback" string="üîô Restaurar Estado Anterior" 
                            type="object" class="btn-warning"
                            confirm="¬øEst√°s seguro de que quieres revertir los cambios? Esto restaurar√° el estado anterior y desactivar√° este snapshot."
                            invisible="not activo"/>
                    <field name="activo" widget="statusbar" statusbar_visible="True,False"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="name"/>
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="fecha_snapshot"/>
                            <field name="user_id"/>
                        </group>
                        <group>
                            <field name="total_proyectos"/>
                            <field name="total_tareas"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Estado de Proyectos">
                            <field name="estado_proyectos" widget="text" 
                                   style="font-family: monospace; white-space: pre-wrap;"/>
                        </page>
                        <page string="Estado de Tareas">
                            <field name="estado_tareas" widget="text" 
                                   style="font-family: monospace; white-space: pre-wrap;"/>
                        </page>
                    </notebook>
                    
                    <div class="alert alert-info" role="alert" invisible="not activo">
                        <p>
                            <i class="fa fa-info-circle"/> Este snapshot est√° activo y puede usarse para restaurar el estado anterior.
                        </p>
                    </div>
                    
                    <div class="alert alert-warning" role="alert" invisible="activo">
                        <p>
                            <i class="fa fa-warning"/> Este snapshot ha sido desactivado y ya no puede usarse para rollback.
                        </p>
                    </div>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Acci√≥n para ver Snapshots -->
    <record id="action_unificar_etapas_snapshot" model="ir.actions.act_window">
        <field name="name">Snapshots de Rollback</field>
        <field name="res_model">leulit_tarea.unificar_etapas_snapshot</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('activo', '=', True)]</field>
        <field name="context">{'search_default_activo': 1}</field>
    </record>

    <!-- Acci√≥n para ver Todos los Snapshots -->
    <record id="action_unificar_etapas_snapshot_all" model="ir.actions.act_window">
        <field name="name">Todos los Snapshots</field>
        <field name="res_model">leulit_tarea.unificar_etapas_snapshot</field>
        <field name="view_mode">tree,form</field>
    </record>

    <!-- Acci√≥n para abrir el wizard -->
    <record id="action_unificar_etapas_wizard" model="ir.actions.act_window">
        <field name="name">Normalizar Etapas</field>
        <field name="res_model">leulit_tarea.unificar_etapas_wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="binding_model_id" ref="project.model_project_project"/>
        <field name="binding_view_types">list,form</field>
    </record>
</odoo>
