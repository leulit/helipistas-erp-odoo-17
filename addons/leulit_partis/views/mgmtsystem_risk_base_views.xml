<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista Tree para Análisis de Riesgos -->
    <record id="view_mgmtsystem_hazard_tree_partis_risk" model="ir.ui.view">
        <field name="name">mgmtsystem.hazard.tree.partis.risk</field>
        <field name="model">mgmtsystem.hazard</field>
        <field name="arch" type="xml">
            <tree string="Análisis de Riesgos" decoration-danger="magerit_inherent_level == 'critical'" decoration-warning="magerit_inherent_level == 'high'">
                <field name="name"/>
                <field name="magerit_asset_id"/>
                <field name="magerit_threat_id"/>
                <field name="magerit_vulnerability_id"/>
                <field name="magerit_inherent_score"/>
                <field name="magerit_inherent_level"/>
                <field name="pilar_treatment_strategy"/>
                <field name="pilar_residual_score"/>
                <field name="pilar_residual_level" decoration-success="pilar_residual_level in ['low', 'medium']"/>
            </tree>
        </field>
    </record>

    <!-- Vista Search para Análisis de Riesgos -->
    <record id="view_mgmtsystem_hazard_search_partis_risk" model="ir.ui.view">
        <field name="name">mgmtsystem.hazard.search.partis.risk</field>
        <field name="model">mgmtsystem.hazard</field>
        <field name="arch" type="xml">
            <search string="Buscar Riesgos">
                <field name="name"/>
                <field name="magerit_asset_id"/>
                <field name="magerit_threat_id"/>
                <field name="magerit_vulnerability_id"/>
                <separator/>
                <filter name="inherent_critical" string="Riesgo Intrínseco Crítico" domain="[('magerit_inherent_level', '=', 'critical')]"/>
                <filter name="inherent_high" string="Riesgo Intrínseco Alto" domain="[('magerit_inherent_level', '=', 'high')]"/>
                <separator/>
                <filter name="residual_critical" string="Riesgo Residual Crítico" domain="[('pilar_residual_level', '=', 'critical')]"/>
                <filter name="residual_high" string="Riesgo Residual Alto" domain="[('pilar_residual_level', '=', 'high')]"/>
                <separator/>
                <filter name="strategy_mitigate" string="Mitigar" domain="[('pilar_treatment_strategy', '=', 'mitigate')]"/>
                <filter name="strategy_accept" string="Aceptar" domain="[('pilar_treatment_strategy', '=', 'accept')]"/>
                <filter name="strategy_transfer" string="Transferir" domain="[('pilar_treatment_strategy', '=', 'transfer')]"/>
                <filter name="strategy_avoid" string="Evitar" domain="[('pilar_treatment_strategy', '=', 'avoid')]"/>
                <group expand="0" string="Agrupar por">
                    <filter name="group_by_asset" string="Activo" context="{'group_by': 'magerit_asset_id'}"/>
                    <filter name="group_by_threat" string="Amenaza" context="{'group_by': 'magerit_threat_id'}"/>
                    <filter name="group_by_inherent_level" string="Nivel Intrínseco" context="{'group_by': 'magerit_inherent_level'}"/>
                    <filter name="group_by_strategy" string="Estrategia" context="{'group_by': 'pilar_treatment_strategy'}"/>
                    <filter name="group_by_residual_level" string="Nivel Residual" context="{'group_by': 'pilar_residual_level'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Vista Form Base - Campos de Análisis MAGERIT/PILAR -->
    <record id="view_mgmtsystem_hazard_form_partis_risk_base" model="ir.ui.view">
        <field name="name">mgmtsystem.hazard.form.partis.risk.base</field>
        <field name="model">mgmtsystem.hazard</field>
        <field name="inherit_id" ref="mgmtsystem_hazard.view_mgmtsystem_hazard_form"/>
        <field name="arch" type="xml">
            <xpath expr="//form/sheet" position="inside">
                <group string="Análisis PART-IS (SGSI)">
                    <group>
                        <field name="magerit_asset_id"/>
                        <field name="magerit_threat_id"/>
                        <field name="magerit_vulnerability_id" domain="['|', ('asset_ids', '=', False), ('asset_ids', '=', magerit_asset_id)]"/>
                    </group>
                    <group>
                        <field name="magerit_probability"/>
                        <field name="magerit_impact"/>
                        <field name="magerit_inherent_score" readonly="1"/>
                        <field name="magerit_inherent_level" readonly="1"/>
                    </group>
                </group>
                <group string="Tratamiento PART-IS (SGSI)">
                    <group>
                        <field name="pilar_treatment_strategy"/>
                        <field name="pilar_control_effectiveness"/>
                    </group>
                    <group>
                        <field name="pilar_control_ids" widget="many2many_tags"/>
                    </group>
                    <group>
                        <field name="pilar_control_summary" colspan="2"/>
                    </group>
                    <group string="Riesgo Residual">
                        <group>
                            <field name="pilar_residual_probability"/>
                            <field name="pilar_residual_impact"/>
                        </group>
                        <group>
                            <field name="pilar_residual_score" readonly="1"/>
                            <field name="pilar_residual_level" readonly="1"/>
                        </group>
                    </group>
                </group>
            </xpath>
        </field>
    </record>

    <!-- Acción para Análisis de Riesgos -->
    <record id="action_mgmtsystem_hazard_risk" model="ir.actions.act_window">
        <field name="name">Análisis de Riesgos SGSI</field>
        <field name="res_model">mgmtsystem.hazard</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{'search_default_is_risk': 1}</field>
        <field name="domain">[('magerit_threat_id', '!=', False)]</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Crear un nuevo análisis de riesgo
            </p>
            <p>
                El análisis de riesgos identifica amenazas sobre activos de información:<br/>
                1. Seleccione el activo afectado<br/>
                2. Identifique la amenaza y vulnerabilidad<br/>
                3. Valore la probabilidad e impacto<br/>
                4. Defina la estrategia de tratamiento<br/>
                5. Aplique controles y evalúe el riesgo residual<br/><br/>
                
                Cumple con los requisitos de EASA PART-IS y metodología MAGERIT/PILAR.
            </p>
        </field>
    </record>

    <!-- Menú para Análisis de Riesgos -->
    <menuitem
        id="menu_leulit_partis_risks"
        name="Análisis de Riesgos"
        parent="menu_leulit_riesgo_root"
        action="action_mgmtsystem_hazard_risk"
        sequence="30"
    />
</odoo>
